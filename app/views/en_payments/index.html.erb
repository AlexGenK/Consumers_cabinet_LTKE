<%= render './consumers/card', consumer: @consumer, manager: @manager, style: 'energy' %>
<br>
<%= render './entab', active: 1 %>
<br>
<h6>Розрахунки <%= l(DateTime.now, format: '%B %Y') %> р.</h6>
<table class="table table-striped table-sm">
	<thead>
		<th class="text-center">Сальдо на початок періоду, грн. з ПДВ</th>
		<th class="text-center">Замовлений обсяг, кВт*год.</th>
		<th class="text-center">Планова ціна, грн. без ПДВ</th>
		<th class="text-center">Вартість, грн. без ПДВ</th>
		<th class="text-center">Вартість, грн. з ПДВ</th>
		<th class="text-center">Оплачено, грн.</th>
		<th class="text-center">Сальдо на кінець періоду, грн. з ПДВ</th>
	</thead>
	<tbody>
		<% if @current_en_consumption %>
			<td class="text-center<%= ' text-danger' if @current_en_consumption.opening_balance < 0 %>">
				<%= number_with_precision(@current_en_consumption.opening_balance, precision: 2, delimiter: " ") %></td>
			<td class='text-center'><%= number_with_delimiter(@current_en_consumption.power, delimiter: " ") %></td>
			<td class='text-center'><%= number_with_precision(@current_en_consumption.tariff, precision: 5, delimiter: " ") %></td>
			<td class='text-center'><%= number_with_precision(@current_en_consumption.cost, precision: 2, delimiter: " ") %></td>
			<td class='text-center'><%= number_with_precision(@current_en_consumption.cost_val, precision: 2, delimiter: " ") %></td>
			<td class='text-center'><%= number_with_precision(@current_en_consumption.money, precision: 2, delimiter: " ") %></td>
			<td class="text-center<%= ' text-danger' if @current_en_consumption.closing_balance < 0 %>">
				<%= number_with_precision(@current_en_consumption.closing_balance, precision: 2, delimiter: " ") %></td>
		<% end %>
	</tbody>
</table>
<div class='row'>
	<div class='col-sm-9'>
		<h6>Графік оплати</h6>
		<table class="table table-striped table-sm">
			<thead>
				<th class="text-center">Дата місяця</th>
				<th class="text-center">% оплати</th>
				<th class="text-center">Планова сума оплати, грн.</th>
				<th class="text-center">Оплачено, грн.</th>
				<th class="text-center">Сальдо, грн.</th>
				<% if can? :manage, EnPayment %>
					<th></th>
				<% end %>
			</thead>
			<tbody>
				<% count = 0 %>
				<% @en_payments.each do |payment| %>
					<tr>
						<td class="text-center"><%= payment.day %></td>
						<td class="text-center"><%= payment.percent %></td>
						<td class='text-center'><%= number_with_precision(@balance[count][:sum], precision: 2, delimiter: ' ') if @calculable %></td>
						<td class='text-right'></td>
						<td class='text-right'></td>
						<% if can? :manage, EnPayment %>
							<td class='text-right'>
								<div class="btn-group">
								<%= link_to edit_consumer_en_payment_path(@consumer, payment), 
									class: "btn btn-outline-dark btn-sm" do %>
									<i class="fas fa-edit test-edit-payment"></i>
								<% end %>
								<%= link_to [@consumer, payment], method: :delete, 
									class: "btn btn-outline-danger btn-sm",
									data: {confirm: "Ви впевнені що хочете видалити плановий платіж?"} do %>
									<i class="fas fa-times test-delete-payment">&nbsp</i>
								<% end %>
								</div>
							</td>
						<% end %>
					</tr>
					<% count += 1 %>
				<% end %>
			</tbody>
		</table>
		<% if can? :manage, EnPayment %>
			<h6>Додати платіж</h6>
			<%= render 'form' %>
		<% end %>
	</div>
	<div class='col-sm-3'>
		<br>
		<b>Поточна заборгованість:</b>
		<br>
		<br>
		<%= link_to consumer_en_invoice_path(@consumer, :format => :pdf), 
			class: "btn btn-outline-dark btn-block", target: :_blank do %>
			<i class="fas fa-file-download"></i> Сформувати рахунок
		<% end %>
	</div>
</div>